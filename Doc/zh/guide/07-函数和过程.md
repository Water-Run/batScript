# 函数和过程  

## 概览  

`batScript`支持两种可调用的代码块:函数(`func`,有返回值的代码块,通过`return`语句返回结果)和**过程**(`proc`,无返回值的代码块,用于执行操作但不返回结果).

函数和过程都支持参数传递,并且函数支持递归调用. 它们的变量作用域默认限制在内部,但可以通过`glob`关键字访问全局作用域.

## 函数  

函数使用`func`关键字定义,必须有返回值. 基本语法如下:

```batscript
func add(a: num, b: num) -> num
{
    return a + b;
}

# 调用函数
set result = add(5, 3);  # result = 8
```

函数可以调用自身,称为递归:  

```batscript
func factorial(n: num) -> num
{
    if (n <= 1)
    {
        return 1;
    }
    return n * factorial(n - 1);
}

set result = factorial(5);  # result = 120
```

### 作用域规则  

函数内定义的变量默认是局部变量,只在函数内有效:

```batscript
set x = 10;  # global variable

func test() -> num
{
    set x = 20;  # local variable
    return x;
}

set y = test();  # y = 20
# x is still 10
```

如果需要在函数内访问或修改全局变量,使用`glob`关键字(详见下文).

### 缺省参数和参数默认值的实现  

#### 缺省参数  

参数名之前有`--`的参数称为缺省参数,在调用函数时可省略.缺省参数必须在非缺省参数之后.  
该参数默认为该类型的`Nil`:

```batscript
proc sample(--a: num, --b: str)
{
    if (?a)
    {
        echo("a is Nil");
    }
    if (?b)
    {
        echo("b is Nil");
    }
}

sample();  # a == Nil, b == Nil
```

可以通过判空运算符`?`和条件语句来实现参数默认值:

```batscript
func greet(name: str, --greeting: str) -> str
{
    if (?greeting)
    {
        set greeting = "Hello";
    }
    return greeting .. ", " .. name .. "!";
}

set msg1 = greet("Alice", "Hi");   # "Hi, Alice!"
set msg2 = greet("Bob");           # "Hello, Bob!"
```

```batscript
func power(base: num, --exponent: num) -> num
{
    if (&exponent == "nil")
    {
        set exponent = 2;
    }
    
    set result = 1;
    set i = 0;
    while (i < exponent)
    {
        set result = result * base;
        set i = i + 1;
    }
    return result;
}

set sq = power(5);      # 25
set cube = power(5, 3); # 125
```

## 过程  

过程使用`proc`关键字定义,不返回值.  

```batscript
proc printMessage(msg: str)
{
    echo(msg);
}

printMessage("Hello, batScript!");
```

例如,以下代码是一个修改全局状态的过程:  

```batscript
set total = 0;

proc addToTotal(value: num)
{
    glob total;
    set total = total + value;
}

addToTotal(10);
addToTotal(20);
# total is now 30
```

过程除了不返回值外,和函数一致.  

## 作用域: 使用`glob`访问全局变量

`glob`关键字用于在函数或过程内部访问和操作全局变量.

```batscript
set counter = 0;

func getCounter() -> num
{
    glob counter; # 声明`counter`是全局的`counter`
    return counter;
}
```

可以使用`glob`从全局变量取值到局部变量(非引用,仅取值):

```batscript
set global_value = 100;

func useGlobal() -> num
{
    set local_value: num = glob global_value;
    set local_value = local_value + 10;
    return local_value;  # returns 110
}

set result = useGlobal();  # result = 110
# global_value is still 100
```

也可以直接修改全局变量:

```batscript
set score = 0;

proc addScore(points: num)
{
    glob score;
    set score = score + points;
}

addScore(10);
addScore(5); # score现在是15
```

`glob`语句必须在函数有效部分的开头.  

---  
**导航**  

[上一个](./06-控制流.md) | [下一个](./08-模块管理.md)  
[教程目录](./01-教程目录.md) | [手册导览](../manual/手册导引.md) | [返回 README](../../../README-zh.md)