# 类型系统  

## 概览  

在原生的`.bat`中,变量只能是字符串类型(或是通过指令处理整数).这显然在使用中是非常不便利的.  
`batScript`提供了一个类型系统,包括数字`num`(无限精度小数),字符串`str`,布尔值`bool`和一维数组`arr`(指定类型).  
其中,字符串和一维数组被称为可迭代类型.  

## 变量基础  

### 声明变量  

在`batScript`中,通过`set`声明变量.在变量名之后,需要通过`: [类型]`声明变量的类型.
变量采用小写+下划线的命名规范:  

```batscript
set var_1: num; # 声明num类型变量 var1
```

> `batScript`目前没有设计空值.当一个变量被创建而没有赋值时,其值为缺省值.详见[缺省值表](../manual/语法/变量缺省值表.md.md)  

一行语句最多只能声明一个变量.在声明时,可以通过`=`为变量赋值:  

```batscript
set var_2: str = "MyVar"; # 声明str类型变量 var2, 并赋初始值"MyVar"
```

> `batScript`暂不支持类型推导.因此,即使在变量创建时赋予了初始值,也要显式的声明变量类型  

使用`let`声明的变量将被视为常量,常量一经创建,不可修改.  
常量采用大写+下划线的命名规范:  

```batscript
let CONST_1: bool = true;
let CONST_2: arr<num>; # 声明常量但不赋值,其值将只能为对应类型的默认值,并会给出警告  
```

## 各类型的详细说明  

在`batScript`中,类型分为两大类: 可迭代类型和不可迭代类型.  
其中,不可迭代类型即为不可逐个访问元素的类型,即单个值,包括`num`和`bool`.可迭代类型与相反,为可逐个访问元素的类型,包括`str`和`arr`.  

### 不可迭代类型  

#### `bool`: 布尔类型  

最简单的类型就是布尔类型.布尔类型的变量只有两个值: `true`或`false`  

```batscript
set bool_var: bool = true;
bool_var = false;
```

#### `num`: 数字类型  

数字类型是`batScript`内建的自定义类型,为无限精度的小数.  
数字类型可以进行计算,计算会保留最少小数位和最小符号的形式.负数会包含负号`-`,正数默认没有符号.  
数字间可以进行计算.  

```batscript
set num_1: int = 1;
set num_2: int;

num_2 = num_1 + 1; # num_2 = 2
num_2 = num_2 - 0.5; # num_2 = 1.5;
num_2 = num_2 - 5 * num_1; # num_2 = -3.5
num_2 = +10000000000000000000000000000000000000000000000000000000000000000000; # num_2 = 10000000000000000000000000000000000000000000000000000000000000000000
num_2 = num_2 - 0.0000000000000000000000000000001; # num_2 = 9999999999999999999999999999999999999999999999999999999999999999999.9999999999999999999999999999999
num_2 = 00123; # num_2 = 123
```

> 在实际使用中,由于基于字符串运算的本质,且未经过多性能优化,不建议使用大于9位的数字  

数字可以进行格式化处理.最常用的是`Num`库提供的系列函数:  

```batscript
lib Int;

# 转换整数
set num_1: int = Num.toInt(3.1415926); # num_1: 3

# 小数位数保留: 截断, 向下, 向上, 四舍五入
num_1 = Num.truncateDecimals(3.1415926,2); # num_1: 3.14
num_1 = Num.floorDecimals(3.1415926,3); # num_1: 3.141
num_1 = Num.ceilDecimals(3.1415926, 1); # num_1: 3.2
num_1 = Num.roundDecimals(3.1415926, 2); # num_1: 3.14
```

> 详见[Num库](../manual/库/Num库.md)  

### 可迭代类型  

#### `str`: 字符串类型  

字符串类型`str`用于表达一个字符串.  
可以使用`""`或`''`来表示一个字符串.  

> 目前这两者是等效的,不过计划在之后将`''`作为`b-string`语法.因此,从兼容性方面考虑,建议使用`""`  

```batscript
set str_1: str;
str_1 = "My String";
```

##### 字符串拼接  

使用运算符`..`可以进行字符串拼接操作.  

```batscript
set str_1: str = "Hello";
set str_2: str = "World";

set str_3: str = str_1 .. " " .. str_2; # Hello World
```

##### 输出  

最常用的输出函数`Std.echo()`接受的参数也是一个字符串:  

```batscript
lib Std;

set output_str: str = "HelloWorld!";
Std.echo(output_str); # HelloWorld!
```

##### 转义符  

`""`和`''`支持C风格的基础转义符.详见[转义符表](../manual/语法/字符串转义符表.md):  

```batscript
lib Std;

/*
Hello
World
*/
Std.echo("Hello\nWorld");
```

` `` `称为原始字符串.其内的内容将保留原有格式.例如,以下是和上述基本相同的代码,只是使用了` `` `:  

```batscript
lib Std;

/*
Hello\nWorld
*/
Std.echo(`Hello\nWorld`);
```

#### `arr`: 一维数组类型  

一维数组是`batScript`支持的独特类型.  
在声明时,必须在结尾使用`<T>`定义类型.其中,`T`是以上三种类型的一种: 即一位数组内不能嵌套数组(否则也不是"一维"数组了).  
一维数组的每一项都是且只能是所定义的类型.通过`[]`表示一维数组,其中每一项之间通过`,`隔开,如`[1,2,3]`.支持尾逗号,如`[true,]`.  

```batscript
set num_arr: arr<num> = [0, 3.14, -100];
set str_arr: arr<str>; # []
```

> 之所以只实现为一位数组而不是列表等更高级的数据类型,主要考虑基于实现上难度和多数`.bat`本身较为简单固定的因素考虑  

##### 一维数组的高级构建  

常用库`Arr`的`build`系列方法提供了一位数组的一些高级构建.例如,以下函数用来构造均为某个值的一位数组:  

```batscript
lib Arr;

set nuums_arr: arr<num> =  Arr.buildNumAllDefault(1, 5); [1, 1, 1, 1, 1]
set strs_arr: arr<num> = Arr.buildStrAllDefault("", 2); ["", ""]
set bools_arr: arr<num> = Arr.buildBoolAllDefault(true, 0); []
```

又比如,使用`buildNumByIncrease()`可以按照指定的递增值构建数组:  

```batscript
lib Arr;

set arr_1: arr<num> = Arr.buildNumByIncrease(0, 1, 3); # 0作为第一项, 步进为1, 3个元素: [0, 1, 2]
```

高级构建的详细文档见[Arr库](../manual/库/Arr库.md).  

#### 可迭代类型的通用语法  

##### 取长  

使用`&`运算符可以获取对应可迭代类型的长度:  

```batscript
set empty_array: arr[str] = [];

set len_1 = &"string"; # 6
set len_2 = &empty_array; # 0
```

##### 索引  

使用`[下标]`进行索引,获取指定位置的元素.下标是一个整数,起点是0:  

```batscript
set arr_1: arr<num> = [-1, 0, 1];
set arr_2: arr<str> = ["-1", "0", "1"];
set str_1: str = "String is iterateable.";

set var_1: num = arr_1[2]; # 1
set var_2: str = arr_2[0]; # "-1"
set var_3: str = str_1[1]; # "t"
```

###### 索引越界  

在`batScript`中,访问越界的索引(即比当前的元素更多),将导致异常.如下列代码:  

```batscript
set arr_1: arr<num> = [1, 2, 3][3] # 索引越界.两个[][]的意思是,访问一维数组[1, 2, 3]的第3项
```

会导致异常信息如下:  

```powershell
batscript: Index out of range in array `arr_1` when trying to get value of index 3 (length: 3)
```

如果不希望导致该异常,一种方式是在索引前取长,添加逻辑进行预处理.例如,以下逻辑设定了异常自定义的异常:  

```batscript
set index: num = 4;
set string: str = "abc";

if (index - 1 >= &string)
{
    err "String" .. `"` .. string .. `"` .. "is shorter than" .. index + 1;
}

set content: str = string[index];
```

输出为:  

```powershell
batscript: String "abc" is shorter than 4
```

或者,使用`Iterateable`库中的`get`系列方法.如:  

```batscript
lib Iterateable;

Iterateable.getArrBool([true], 1); # 访问第二项.返回该类型的缺省值, 即bool的缺省值false
Iterateable.getArrBoolWithDefault([true], 1, true) # 访问第二项.返回设定的缺省值, 即第三个参数true
```

`get`的更多系列方法,见[Iterateable类](../manual/库/Iterateable库.md)中的详细说明.

## 类型转换  

在`batScript`中,类型可以使用`@`进行转换.语法是,`[转换后的类型]@[被转换的值]`:  

```batscript
set num_to_string: str = str@123; # "123"
```

> 具体转换的逻辑,见[类型转换逻辑](../manual/语法/类型转换逻辑.md)  

---  

**导航**  

[上一个](#) | [下一个](#)  
[教程目录](#) | [手册导览](#) | [返回 README](#)
